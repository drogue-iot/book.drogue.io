<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Update Protocol :: Drogue IoT</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">

      <a class="navbar-item" href="../..">
        <img class="navbar-brand-image" src="../../_/img/logo.png" alt="Drogue IoT"/>
      </a>
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs">
          </div>
        </div>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.drogue.io" target="_blank">Project</a>
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drogue-ajour" data-version="dev">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Drogue Ajour</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="using.html">User Guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Admin Guide</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="protocol.html">Update Protocol</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="image-format.html">Image Format</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="api/index.html">API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="api/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="api/endpoints.html">Endpoints</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="api/schemas.html">Schemas</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drogue Ajour</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Drogue Ajour</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-cloud/dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-cloud/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.9/index.html">0.9</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.8/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-device/dev/index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-device/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-workshops/index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-workshops/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../embassy/dev/index.html">Embassy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../embassy/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Drogue Ajour</a></li>
    <li><a href="protocol.html">Update Protocol</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/drogue-iot/drogue-ajour/edit/main/docs/modules/ROOT/pages/protocol.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Update Protocol</h1>
<div class="paragraph">
<p>Drogue Ajour uses a custom application level protocol sent on a special 'dfu' channel in Drogue Cloud to communicate with a device or gateway. The protocol is stateless, meaning that Drogue Ajour will track only send out firmware updates to devices that are reporting their status.</p>
</div>
<div class="paragraph">
<p>The protocol is designed so that devices do not have to be online continuously during the update, but can receive firmware at their own pace.</p>
</div>
<div class="paragraph">
<p>The protocol uses Consise Binary Object Representation (CBOR), to ensure a small message size that works well with embedded devices.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/update_protocol.png" alt="Update protocol">
</div>
</div>
<div class="paragraph">
<p>The above sequence diagram corresponds to the example messages below. For descriptive purposes, the examples here are provided in JSON.</p>
</div>
<div class="paragraph">
<p>A typical firmware update cycle runs as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At any given time, a device publishes message to the 'dfu' channel with the following payload</p>
<div class="listingblock">
<div class="content">
<pre>{
   "version": "0.1.0",
   "correlation_id": 1 // Optional: Opaque request identifier, for devices that aggregate multiple updates
   "mtu": 512, // Optional: The desired block size to use for firmware blobs
}</pre>
</div>
</div>
<div class="paragraph">
<p>This allows the Drogue Ajour to check if an update is necessary at all.</p>
</div>
</li>
<li>
<p>Drogue Ajour checks the desired firmware for that particular device and will attempt to locate it in the firmware registry.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the device is already updated, a 'dfu' command is sent to the device with the following payload:</p>
<div class="listingblock">
<div class="content">
<pre>{
  "sync": {
    "version": "0.1.0", // Desired firmware version
    "correlation_id": 1 // Optional: Should be set to the id from the device status
    "poll": 300, // The amount of time to wait before checking in again
  }
}</pre>
</div>
</div>
</li>
<li>
<p>If a device needs to be updated, a 'dfu' command is sent to the device with the following payload</p>
<div class="listingblock">
<div class="content">
<pre>{
  "write": {
    "version": "0.1.1", // Version of blob
    "offset": 0, // Offset this blob should be written to
    "data": aGVsbG8= // Base64-encoded firmware block (Binary in CBOR)
  }
}</pre>
</div>
</div>
</li>
<li>
<p>If there is no new information about firmware, and server needs the client to wait before asking again, a 'wait' command is sent.</p>
<div class="listingblock">
<div class="content">
<pre>{
  "write": {
    "poll": 300, // The amount of time to wait before checking in again
  }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Device receives command</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>When a device is seeing the "sync" operation, it should make sure it&#8217;s current firmware version is marked as 'good' if it have not already done so. The 'poll' field can be used as a heuristic of how long the device should wait before checking in again.</p>
</li>
<li>
<p>When a device is seeing the "write" operation, it should write the provided data to it&#8217;s storage. Once persisted, it should report back the next expected offset and last received version:</p>
<div class="listingblock">
<div class="content">
<pre>{
   "version": "0.1.0",
   "mtu": 512, // The desired block size to use for the next firmware block
   "status": {
      "version": "0.1.1", // Version of the last block the device received from the server. To safeguard against new versions arriving
      "offset": 512, // Current write offset after applying the last firmware block.
   }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Server receives status event</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If device is in sync, optionally reply with a sync command indicating the delay before polling again.</p>
</li>
<li>
<p>When the server receives the next event from the device, it repeats the previous write step until the complete firmware have been sent. When the final block is confirmed written, and it is desired to deploy the new firmware, the fleet-manager will send the following command:</p>
<div class="listingblock">
<div class="content">
<pre>{
  "swap": {
    "version": "0.1.1",
    "checksum": "097d501382f5817eb2c5f741d37845158c76dd6a8af899001b36b5a75188aeeb"
  }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Device receives command</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>When the device receives the 'swap' command, it should initiate the firmware update and report back with the updated version as soon as it&#8217;s back online.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
