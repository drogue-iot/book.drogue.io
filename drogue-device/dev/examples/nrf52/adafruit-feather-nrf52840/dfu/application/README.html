<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Adarfuit nRF52840 Feather DFU example :: Drogue IoT</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../../../../../../_'</script>
    <link rel="icon" href="../../../../../../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../../../..">
        <img class="navbar-brand-image" src="../../../../../../../_/img/logo.png" alt="Drogue IoT"/>
      </a>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drogue-device" data-version="dev">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../../../index.html">Drogue Device</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../concepts.html">Actors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../getting_started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../basic_application.html">Basic Application</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../drivers.html">Drivers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../bsp.html">Board Support Packages</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../../../../../embassy/dev/index.html">Embassy</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../../../examples.html">Examples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basic</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../rp/pico/blinky/README.html">Raspberry Pi Pico Blinky</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32h7/nucleo-h743zi/blinky/README.html">STM32 Nucleo-H743 blinky</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32u5/iot02a/blinky/README.html">STM32 IoT Discovery board blinky</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ble</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="README.html">Adafruit Feather nRF52840 Bootloader DFU example</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/ble-temperature/README.html">BBC micro:bit v2 BLE temperature sensor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/dfu/README.html">Microbit Bootloader + DFU over BLE</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../nrf52840-dk/ble-mesh/README.html">nrf52840-dk BLE Mesh example</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cloud</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/esp8266/README.html">BBC micro:bit v2 + ESP8266 WiFi adapter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../std/cloud/README.html">Example sending telemetry data from Drogue Device to Drogue Cloud</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../std/esp8266/README.html">Example using a USB-to-Serial adapter + ESP8266 adapter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32l4/iot01a-wifi/README.html">STM32 IoT Discovery board (iot01a) reporting sensor data using WiFi</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Display</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/compass/README.html">BBC micro:bit v2 compass showing direction in led display</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/jukebox/README.html">BBC micro:bit v2 disco jukebox and light show</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/uart/README.html">BBC micro:bit v2 uart and matrix display</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32h7/nucleo-h743zi/epd/README.html">STM32 Nucleo-H743 7-color e-paper display</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Lorawan</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../std/rak811/README.html">RAK811 LoRa Adapter with AT command firmware</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32l0/lora-discovery/README.html">STM32 LoRaWAN Discovery board connecting to The Things Network</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32l1/rak811/README.html">RAK811 Tracker Node connecting to The Things Network</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32wl/nucleo-wl55/README.html">STM32 Nucleo-WL55 using LoRaWAN connecting to The Things Network</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Other</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#examples/nrf52/adafruit-feather-nrf52840/dfu/bootloader/README.adoc">Bootloader for Adafruit nRF52840 chips</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Uart</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/uart/README.html">BBC micro:bit v2 uart and matrix display</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Wifi</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../microbit/esp8266/README.html">BBC micro:bit v2 + ESP8266 WiFi adapter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../std/esp8266/README.html">Example using a USB-to-Serial adapter + ESP8266 adapter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../stm32l4/iot01a-wifi/README.html">STM32 IoT Discovery board (iot01a) reporting sensor data using WiFi</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drogue Device</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../../../drogue-cloud/dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../../../drogue-cloud/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.9/index.html">0.9</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.8/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../../../../../../drogue-cloud/0.4/index.html">0.4</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../../../index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../../../index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../../../drogue-workshops/index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../../../drogue-workshops/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../../../embassy/dev/index.html">Embassy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../../../embassy/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../../../index.html">Drogue Device</a></li>
    <li><a href="../../../../../examples.html">Examples</a></li>
    <li>Ble</li>
    <li><a href="README.html">Adafruit Feather nRF52840 Bootloader DFU example</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/drogue-iot/drogue-device/edit/main/docs/modules/ROOT/pages/examples/nrf52/adafruit-feather-nrf52840/dfu/application/README.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Adarfuit nRF52840 Feather DFU example</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Example for the Adafruit nRF52840 Feather demonstrating bootloader and firmware update capabilities
using external flash of the Feather Express. The example assumes that the nRF softdevice is installed.
With this example, you can use two different options to update the firmare:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BLE</p>
</li>
<li>
<p>UART</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hardware"><a class="anchor" href="#_hardware"></a>Hardware</h3>
<div class="ulist">
<ul>
<li>
<p>One of <a href="https://www.adafruit.com/product/4062">Adafruit nRF52840 Feather Express</a> or <a href="https://www.adafruit.com/product/4516">Adafruit nRF52840 Feather Sense</a> (requires soldering to the bottom debug pads).</p>
</li>
<li>
<p>A SWD debug probe such as <a href="https://github.com/probe-rs/rusty-probe">Rusty Probe</a> or using a <a href="https://www.raspberrypi.com/products/raspberry-pi-pico/">Raspberry Pi Pico</a> and load it with <a href="https://github.com/majbthrd/DapperMime">this firmware</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_software"><a class="anchor" href="#_software"></a>Software</h3>
<div class="paragraph">
<p>Make sure you have the latest versions (<code>cargo install &lt;tool&gt;</code>) of these tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>probe-run</code></p>
</li>
<li>
<p><code>probe-rs-cli</code></p>
</li>
<li>
<p><code>cargo-flash</code></p>
</li>
<li>
<p><code>cargo-binutils</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a>Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_erase_current_settings"><a class="anchor" href="#_erase_current_settings"></a>Erase current settings</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">probe-rs-cli erase --chip nRF52840_xxAA</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flash_bootloader"><a class="anchor" href="#_flash_bootloader"></a>Flash bootloader</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cargo flash --manifest-path ../bootloader/Cargo.toml --release --chip nRF52840_xxAA</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flash_nrf_softdevice"><a class="anchor" href="#_flash_nrf_softdevice"></a>Flash nRF Softdevice</h3>
<div class="paragraph">
<p>Download the softdevice version 7.3.0 <a href="https://www.nordicsemi.com/Products/Development-software/s140/download">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">probe-rs-cli download path-to-softdevice.hex --format Hex --chip nRF52840_xxAA</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flash_application"><a class="anchor" href="#_flash_application"></a>Flash application</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">REVISION=blue cargo flash --release --chip nRF52840_xxAA</code></pre>
</div>
</div>
<div class="paragraph">
<p>When started, the device will blink it&#8217;s LED at a fixed interval. You can now modify the example, and DFU it to the device with the using BLE GATT. To do that, it&#8217;s convenient to use the <code>drgdfu</code> tool (<code>cargo install <a href="https://github.com/drogue-iot/drgdfu" class="bare">https://github.com/drogue-iot/drgdfu</a></code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_flashing_a_new_revision_using_firmware_update"><a class="anchor" href="#_flashing_a_new_revision_using_firmware_update"></a>Flashing a new revision using firmware update</h3>
<div class="paragraph">
<p>One change you can do is to blink the red led instead of the blue led (change line 121 to <code>board.red_led</code>). We can then rebuild the application and flash it using the <code>drgdfu</code> tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">REVISION=red cargo objcopy --release -- -O binary red.bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modifying the version in <code>Cargo.toml</code> or passing a <code>REVISION</code> environment variable will compile the firmware with a new version identifier. This identifier can be used to decide if a firmware update is needed at all by the <code>drgdfu</code>.</p>
</div>
<div class="paragraph">
<p>To use the <code>drgdfu</code> tool to update over BLE, generate a metadata file first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drgdfu generate --version red --file red.bin &gt; red.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then use refer to the metadata file when running the DFU process (The MAC address can be found from discovering your device using any tool like <code>bluetoothsctl</code> and the command <code>scan on</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">drgdfu upload ble-gatt --device F8:56:35:45:1C:3C file red.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be patient! The firmware update process on the device takes up to 20-30 seconds.</p>
</div>
<div class="paragraph">
<p>Once finished, the <code>drgdfu</code> tool will wait for the device to swap the new firmware and report back the expected version. If not, it will restart the DFU process.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using the serial update, the serial port might disappear when the swap is performed. Follow the instructions as provided by the tool.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../../../../_/js/site.js"></script>
<script async src="../../../../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
