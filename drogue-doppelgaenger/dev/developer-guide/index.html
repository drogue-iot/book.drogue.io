<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Developer Guide :: Drogue IoT</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../../_'</script>
    <link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">

      <a class="navbar-item" href="../../..">
        <img class="navbar-brand-image" src="../../../_/img/logo.png" alt="Drogue IoT"/>
      </a>
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs">
          </div>
        </div>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.drogue.io" target="_blank">Project</a>
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drogue-doppelgaenger" data-version="dev">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Drogue Doppelgänger</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Developer Guide</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pre-reqs.html">Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="local.html">Local developer setup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../api/index.html">API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/endpoints.html">Endpoints</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/schemas.html">Schemas</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drogue Doppelgänger</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../drogue-ajour/dev/index.html">Drogue Ajour</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-ajour/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-cloud/dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-cloud/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.9/index.html">0.9</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.8/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../../drogue-cloud/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-device/dev/index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-device/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Drogue Doppelgänger</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-workshops/index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-workshops/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Drogue Doppelgänger</a></li>
    <li><a href="index.html">Developer Guide</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/drogue-iot/drogue-doppelgaenger/edit/main/docs/modules/developer-guide/pages/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Developer Guide</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Doppelgänger is mainly a Rust based project, with code located in the same repository. It uses a workspace layout,
splitting up the different component into different crates. The following sections should give you an overview and
enable you to navigate the project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts"><a class="anchor" href="#_concepts"></a>Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some concepts used in this documentation are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Application</dt>
<dd>
<p>A group of resources which belong together, isolating it from others.</p>
</dd>
<dt class="hdlist1">Thing</dt>
<dd>
<p>A "digital" (or virtual) thing, which is being represented by Doppelgaenger. It is part of exactly one
application. This doesn&#8217;t necessarily map to a device directly, but maybe to some part of the device.</p>
<div class="paragraph">
<p>While there exist no hard references between things, it is possible to use soft references (pointers) which reference
other things. With this, it is possible to establish relationships (like parent/child, groups, …) between things.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture"><a class="anchor" href="#_architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#figure-architecture">Figure 1, &#8220;Overview of components&#8221;</a> shows an overview of the different components involved in a deployment.
These can also be found as root level elements in the repository.</p>
</div>
<div id="figure-architecture" class="imageblock">
<div class="content">
<img src="_images/architecture.svg" alt="Overview of components">
</div>
<div class="title">Figure 1. Overview of components</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IoT Connectivity</dt>
<dd>
<p>This is the source of the events which should be processed by Doppelgaenger, and the target for
commands. This can be Drogue Cloud, but it could also be some other component, like a standard MQTT Broker or a
Kafka topic.</p>
<div class="paragraph">
<p>Events in this system do not need to be in the format of Doppelgaenger. This system is not considered part of
Doppelgaenger.</p>
</div>
</dd>
<dt class="hdlist1">Injector</dt>
<dd>
<p>The injector extracts events from an external IoT connectivity system and injects them into Doppelgaengner.</p>
<div class="paragraph">
<p>It will translate between the external IoT connectivity protocol (e.g. MQTT) and the internal Kafka topic. It will also
translate from an external payload format, into a Doppelgaenger event.</p>
</div>
</dd>
<dt class="hdlist1">Kafka</dt>
<dd>
<p>Kafka is being used to stream events into the system, but also to stream internal events between components.</p>
</dd>
<dt class="hdlist1">Processor</dt>
<dd>
<p>The processor takes events from the stream and executes the events. Events are mostly updating thing
states.</p>
<div class="paragraph">
<p>The processor loads the current state, executes the command, reconciles the thing, persists the new state, and sends out
events generated by the process.</p>
</div>
</dd>
<dt class="hdlist1">PostgreSQL</dt>
<dd>
<p>The persistent storage for the state. This can be PostgreSQL directly, but also any other database which
uses the PostgreSQL protocol and syntax.</p>
<div class="paragraph">
<p>As there are no hard references between things, it is actually possible to have multiple PostgreSQL instances, and shard
the things among them.</p>
</div>
</dd>
<dt class="hdlist1">Waker</dt>
<dd>
<p>Things can request to be woken up after a certain time, to re-process, re-try, or reconcile. The waker will
send "wakeup" events to Kafka, when the wake period expires.</p>
</dd>
<dt class="hdlist1">Backend</dt>
<dd>
<p>The backend services provides an API to the Things. This API can be used to manage things, but also to
listen to state changes. It should not be used to stream data into the system.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internal_architecture"><a class="anchor" href="#_internal_architecture"></a>Internal Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The illustration above showed the main components of the default deployment. However internally, Doppelgaenger is
a bit more modular, which allows for other deployment models, such as the "single server binary".</p>
</div>
<div class="paragraph">
<p>Most of the internal components are located in the <code>core</code> crate. The other projects only set up a suitable process and
container image.</p>
</div>
<div id="figure-internal-architecture" class="imageblock">
<div class="content">
<img src="_images/internal_architecture.svg" alt="Internal components">
</div>
<div class="title">Figure 2. Internal components</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Processor</dt>
<dd>
<p>The processor simply consumes events from the Kafka stream and executes the commands using the "Service".
It will perform the acknowledgement handling with Kafka and re-try in cases of failure of broken optimistic locks.</p>
</dd>
<dt class="hdlist1">Service</dt>
<dd>
<p>The main service, taking care of processing requests. It will load the current state from the "Storage",
apply the required operation, and then use the "Machine" to reconcile the state. If that was successful, it
will<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>:</p>
<div class="ulist">
<ul>
<li>
<p>Persist the new state</p>
</li>
<li>
<p>Send internal events</p>
</li>
<li>
<p>Send commands</p>
</li>
<li>
<p>Send change notifications (if the thing was changed)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Listener</dt>
<dd>
<p>The listener which receive change events from the "notifications" topic, and send out notifications to
its listeners. The listener will also handle things like sending initial state or differential send.</p>
</dd>
<dt class="hdlist1">Management</dt>
<dd>
<p>Execute management operations on the things, as they get requested through the REST API. The process isn&#8217;t
that different from the Processor&#8217;s. However, the REST API provides a different API, suitable for external consumption.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_assumptions"><a class="anchor" href="#_assumptions"></a>Assumptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Doppelgaenger makes a few assumptions:</p>
</div>
<div class="sect2">
<h3 id="_dominance_of_ingress_traffic"><a class="anchor" href="#_dominance_of_ingress_traffic"></a>Dominance of ingress traffic</h3>
<div class="paragraph">
<p>It is expected that the traffic flowing into the system is much more than the traffic flowing out of Doppelgaenger.</p>
</div>
<div class="paragraph">
<p>This is a typical IoT scenario, where most data (telemetry) gets sent by devices towards the cloud.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_key_based_on_thing_id"><a class="anchor" href="#_kafka_key_based_on_thing_id"></a>Kafka key based on thing ID</h3>
<div class="paragraph">
<p>Kafka can guarantee the order of events only for a key. Therefore, the (Kafka) key for events must be ID of the thing.</p>
</div>
<div class="paragraph">
<p>This guarantees that all events for a thing are processed in the correct order, and also makes breaking the optimistic
lock during a thing update much less likely.</p>
</div>
<div class="paragraph">
<p>Doppelgaenger holds an optimistic lock on things while processing events or backend requests. When the lock breaks, it
will re-try. However, this costs additional resources and should be avoided.</p>
</div>
<div class="paragraph">
<p>Still, it cannot be avoided completely when using the backend API for mutating requests.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_noteworthy"><a class="anchor" href="#_noteworthy"></a>Noteworthy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_traits_and_implementations"><a class="anchor" href="#_traits_and_implementations"></a>Traits and implementations</h3>
<div class="paragraph">
<p>Currently, Doppelgaenger uses Rust "traits" for abstracting from actual implementations. However, it is currently not
possible to swap out implementations during runtime.</p>
</div>
<div class="paragraph">
<p>It would be possible to create a new "Storage" implementation based on a database which is not PostgreSQL. However, it
currently would not be possible to choose an implementation during runtime. It has to be done during compilation and
required some small changes in the code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_single_server_binary"><a class="anchor" href="#_single_server_binary"></a>Single server binary</h3>
<div class="paragraph">
<p>Instead of deploying different containers to run the different services, it is possible to run a "single server binary"
from the <code>server</code> crate.</p>
</div>
<div class="paragraph">
<p>This includes all components in a single binary, but also doesn&#8217;t allow one to scale out. It is great for testing
though.</p>
</div>
</div>
<div class="sect2">
<h3 id="_frontend"><a class="anchor" href="#_frontend"></a>Frontend</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The cake is a lie!</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Doug Rattman<br>
<cite>Portal</cite>
</div>
</div>
<div class="paragraph">
<p>Currently a folder for a frontend exists, but it isn&#8217;t being used. However, there is a <code>debugger</code> folder, which
provides kind of an "explorer" web application, to browse through the data of things.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Not necessarily in this order
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
