<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>A basic Embassy application :: Drogue IoT</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">

      <a class="navbar-item" href="../..">
        <img class="navbar-brand-image" src="../../_/img/logo.png" alt="Drogue IoT"/>
      </a>
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs">
          </div>
        </div>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.drogue.io" target="_blank">Project</a>
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="embassy" data-version="dev">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Embassy</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="runtime.html">Runtime</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="traits.html">APIs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="hal.html">Hardware Abstraction Layer</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="nrf.html">nRF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stm32.html">STM32</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bootloader.html">Bootloader</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="getting_started.html">Getting started</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="basic_application.html">Basic application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="layer_by_layer.html">Layer by Layer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="examples.html">Examples</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Embassy</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../drogue-cloud/dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-cloud/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.9/index.html">0.9</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.8/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-device/dev/index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-device/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-workshops/index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-workshops/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Embassy</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Embassy</a></li>
    <li><a href="getting_started.html">Getting started</a></li>
    <li><a href="basic_application.html">Basic application</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/embassy-rs/embassy/edit/master/docs/modules/ROOT/pages/basic_application.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">A basic Embassy application</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>So you&#8217;ve got one of the <a href="examples.html" class="xref page">examples</a> running, but what now? Let&#8217;s go through a simple Embassy application for the nRF52 DK to understand it better.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_main"><a class="anchor" href="#_main"></a>Main</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full example can be found <a href="https://github.com/embassy-rs/embassy/tree/book-poc/docs/modules/ROOT/examples/basic">here</a>.</p>
</div>
<div class="sect2">
<h3 id="_rust_nightly"><a class="anchor" href="#_rust_nightly"></a>Rust Nightly</h3>
<div class="paragraph">
<p>The first thing you&#8217;ll notice is a few declarations stating that Embassy requires some nightly features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">#![no_std]
#![no_main]
#![feature(type_alias_impl_trait)]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dealing_with_errors"><a class="anchor" href="#_dealing_with_errors"></a>Dealing with errors</h3>
<div class="paragraph">
<p>Then, what follows are some declarations on how to deal with panics and faults. During development, a good practice is to rely on <code>defmt-rtt</code> and <code>panic-probe</code> to print diagnostics to the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">use defmt::*;
use embassy::executor::Spawner;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_task_declaration"><a class="anchor" href="#_task_declaration"></a>Task declaration</h3>
<div class="paragraph">
<p>After a bit of import declaration, the tasks run by the application should be declared:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">        led.set_low();
        Timer::after(interval).await;
    }
}

#[embassy::main]
async fn main(spawner: Spawner, p: Peripherals) {
    let led = Output::new(p.P0_13, Level::Low, OutputDrive::Standard);
    unwrap!(spawner.spawn(blinker(led, Duration::from_millis(300))));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An embassy task must be declared <code>async</code>, and may NOT take generic arguments. In this case, we are handed the LED that should be blinked and the interval of the blinking.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that there is no busy waiting going on in this task. It is using the Embassy timer to yield execution, allowing the microcontroller to sleep in between the blinking.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_main_2"><a class="anchor" href="#_main_2"></a>Main</h3>
<div class="paragraph">
<p>The main entry point of an Embassy application is defined using the <code>#[embassy::main]</code> macro. The entry point is also required to take a <code>Spawner</code> and a <code>Peripherals</code> argument.</p>
</div>
<div class="paragraph">
<p>The <code>Spawner</code> is the way the main application spawns other tasks. The <code>Peripherals</code> type holds all peripherals that the application may use. In this case, we want to configure one of the pins as a GPIO output driving the LED:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust"></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>#[embassy::main]</code> takes an optional <code>config</code> paramter specifying a function that returns an instance of HAL&#8217;s <code>Config</code> struct. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">fn embassy_config() -&gt; embassy_nrf::config::Config {
    embassy_nrf::config::Config::default()
}

#[embassy::main(config = "embassy_config()")]
async fn main(_spawner: embassy::executor::Spawner, p: embassy_nrf::Peripherals) {
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happens when the <code>blinker</code> task have been spawned and main returns? Well, the main entry point is actually just like any other task, except that you can only have one and it takes some specific type arguments. The magic lies within the <code>#[embassy::main]</code> macro. The macro does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creates an Embassy Executor instance</p>
</li>
<li>
<p>Initializes the microcontroller to get the <code>Peripherals</code></p>
</li>
<li>
<p>Defines a main task for the entry point</p>
</li>
<li>
<p>Runs the executor spawning the main task</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is also a way to run the executor without using the macro, in which case you have to create the <code>Executor</code> instance yourself.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_cargo_toml"><a class="anchor" href="#_the_cargo_toml"></a>The Cargo.toml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project definition needs to contain the embassy dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">embassy = { version = "0.1.0", path = "../../../../../embassy", features = ["defmt", "nightly"] }
embassy-nrf = { version = "0.1.0", path = "../../../../../embassy-nrf", features = ["defmt", "nrf52840", "time-driver-rtc1", "gpiote", "nightly"] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on your microcontroller, you may need to replace <code>embassy-nrf</code> with something else (<code>embassy-stm32</code> for STM32. Remember to update feature flags as well).</p>
</div>
<div class="paragraph">
<p>In this particular case, the nrf52840 chip is selected, and the RTC1 peripheral is used as the time driver.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
