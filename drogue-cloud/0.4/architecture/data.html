<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Data plane :: Drogue IoT</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../../_'</script>
    <link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">
        <img class="navbar-brand-image" src="../../../_/img/logo.png" alt="Drogue IoT"/>
      </a>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drogue-cloud" data-version="0.4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Drogue Cloud</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../concepts.html">Concepts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="data.html">Data plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="control.html">Control plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="devices.html">Devices, gateways &amp; services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="addons.html">Additional components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="services.html">Noteworthy services</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../deployment/index.html">Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment/pre-reqs.html">Pre-Requisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment/cluster.html">Prepare the cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment/installer.html">Run the installer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deployment/development.html">Deploy from the repository</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drogue Cloud</span>
    <span class="version">0.4</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../0.5/index.html">0.5</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">0.4</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-device/dev/index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-device/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../drogue-workshops/index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../drogue-workshops/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Drogue Cloud</a></li>
    <li><a href="index.html">Architecture</a></li>
    <li><a href="data.html">Data plane</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.4</button>
  <div class="version-menu">
    <a class="version is-missing" href="../../dev/index.html">dev</a>
    <a class="version" href="../../0.6/architecture/data.html">0.6</a>
    <a class="version" href="../../0.5/architecture/data.html">0.5</a>
    <a class="version is-current" href="data.html">0.4</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/drogue-iot/drogue-cloud/edit/release-0.4/docs/modules/architecture/pages/data.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Data plane</h1>
<div class="sect1">
<h2 id="_protocol_normalization"><a class="anchor" href="#_protocol_normalization"></a>Protocol normalization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A core feature of Drogue Cloud is the abstraction of protocols. Typical IoT protocols are MQTT, CoAP, OPC UA, but also HTTP is being used by some devices.</p>
</div>
<div class="paragraph">
<p>Ideally, your cloud side application only needs to think about implementing one protocol, in order to
interact with your devices. However, different IoT protocols provide benefits on the device side. As the
devices are more constrained than the cloud side, Drogue Cloud tries to levarage the benefits of IoT protocols,
while providing a normalization layer on the cloud side, that makes it easy for your applications to consume the data.</p>
</div>
<div class="paragraph">
<p>But also on the cloud side, different ways to consume data exists. May that be a direct connection to a Kafka topic, again MQTT, or a simple Web socket connection. Drogue Cloud tries to be integrate as good as possible, and not force you into a specific API.</p>
</div>
<div class="paragraph">
<p>Drogue Cloud is based on Knative, and internally uses the Cloud Events specification to forward messages.
Cloud events on the other side have different mappings to transport channels, such as MQTT, Kafka, HTTP, etc.. And while Cloud Events can also be used on the external interfaces of Drogue Cloud, it isn&#8217;t a requirement, and you can use your custom protocols as you need.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/data-plane.svg" alt="Data plane overview"></span></p>
</div>
<div class="paragraph">
<p>Devices communicate with the <em>Protocol endpoints</em>, which implement the protocol specific mapping between the
actual protocol and the internal Cloud Events based message format.</p>
</div>
<div class="paragraph">
<p>The protocol endpoints also authentication and authorize devices and its configured gateways. Validate credentials, or X.509 client certificates and ensure that the devices are enabled in the system.</p>
</div>
<div class="paragraph">
<p>Once the device is granted access to publish (or receive) data, the protocol endpoint will hook up the device
to the internal message flow. It subscribes to commands targeted towards the device, and forwards messages
from the device to an internal Knative eventing endpoint which takes care of processing and delivering the messgaes.</p>
</div>
<div class="paragraph">
<p>The actual payload of the messages is not processed, and just passed on the Knative eventing destination.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In some cases the payload of an incoming request is not equal to the payload of the actual message.</p>
</div>
<div class="paragraph">
<p>For example, a request from "The Things Network" (TTN) conists of a payload, which contains meta data (like the device ID), and then the actual payload of the original message from the device.</p>
</div>
<div class="paragraph">
<p>In cases like this it depends on the protocol adapter what it considers payload and what is metadata. In the case
of TTN, you can configure if you want to have the full request payload, or just the original device payload.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_message_persistence"><a class="anchor" href="#_message_persistence"></a>Message persistence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a protocol endpoint drops off an incoming message to the Knative eventing service, this service is
backed by a Kafka topic<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>The responsibility of Kafka is to deliver messages to the target consumer. Peristing messages if needed, and
handling shared consumer groups if requested. This allows Drogue Cloud to buffer messages when the consumer is
unavailable or of there is a peak of messages that the consumer currently cannot handle. Also, this allows to
drive a shared consumer model, where in a group of consumers only one receives a messages. This concept is used
to share the load for messages to multiple instances of a consumer.</p>
</div>
<div class="paragraph">
<p>As mentioned before, Drogue Cloud relies on a Knative eventing destination which provides these guarantees, and
uses Kafka to implement this. However, it is possible to replace the Kafka implementation with a different implementation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_consuming_messages"><a class="anchor" href="#_consuming_messages"></a>Consuming messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Applications, like devices, are provided by the user and live outside of the Drogue Cloud instance. They still
may run on the same cluster. By "consuming" messages, we mean that messages, sent by a device, are forwarded
to the target application. It also implies a channel back to the device, for sending commands. However,
as device-to-cloud messages are much more frequent, we simply focus on "consuming" messages.</p>
</div>
<div class="paragraph">
<p>In general there are "push" or "pull" modes. Messages are always sent to the consumer in an event oriented manner, "push" and "pull" only refers on who initiates the process.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Push model</dt>
<dd>
<p>A sender service inside the Drogue Cloud instance constantly tries to reach out to a target destination, trying to deliver messages.</p>
<div class="paragraph">
<p>This might be a Knative eventing service, which tries to deliver messages from the Kafka topic to an HTTP endpoint.</p>
</div>
</dd>
<dt class="hdlist1">Pull mode</dt>
<dd>
<p>A passive service inside the Drogue Cloud instance that waits for a consumer to connect. Once
the consumer connected successfully, messages start to flow.</p>
<div class="paragraph">
<p>This might be an MQTT server, which publishes messages to the consumer once it subscribed.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication_authorization"><a class="anchor" href="#_authentication_authorization"></a>Authentication &amp; authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication (authn) and authorization (authz) happens in two different realms<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> of the system. On the
device facing side and on the user/application facing side. And while it may be technically incorrect, in the
next few paragraphs "authentication" implies authentication and authorization, unless noted otherwise.</p>
</div>
<div class="paragraph">
<p>The device facing authentication is backed by the device registry, which is the central storage for device
information and configuration. It also stores credentials of devices, like passwords or X.509 trust anchors.</p>
</div>
<div class="paragraph">
<p>The user facing authentication is backed by an Open ID connect, single sign-on system. By default we use Keycloak, however it should be possible to use any other Open ID connect compatible solution.</p>
</div>
<div class="paragraph">
<p>Services internally also use the same SSO solution as external users.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Technically it is a Knative eventing service, which could be implemented by different technologies. The default implementation for Drogue Cloud though is Kafka.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The term "realm" doesn&#8217;t refer to an HTTP or Keycloak "relam" here
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
