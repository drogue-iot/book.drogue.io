<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Device firmware :: Drogue IoT</title>
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4BRXRBJJ1"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-Z4BRXRBJJ1')</script>
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">

      <a class="navbar-item" href="../..">
        <img class="navbar-brand-image" src="../../_/img/logo.png" alt="Drogue IoT"/>
      </a>
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs">
          </div>
        </div>

      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.drogue.io" target="_blank">Project</a>
        <a class="navbar-item" href="https://blog.drogue.io" target="_blank">Blog</a>
        <a class="navbar-item" href="https://matrix.to/#/#drogue-iot:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://book.drogue.io">Documentation</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="drogue-workshops" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Drogue IoT Workshops</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started/index.html">Getting started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../external/telemetry-e2e.html">Telemetry end-to-end</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ttn-lorawan/index.html">LoRaWAN end-to-end</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/toolchain.html">Embedded toolchain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/account-setup.html">TTN account setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/drogue-cloud.html">Drogue Cloud setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/firmware.html">Device firmware</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/quarkus-application.html">Quarkus application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/nodejs-application.html">Node.js application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ttn-lorawan/making-changes.html">Making changes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quarkus-mqtt-starter/index.html">Quarkus MQTT integration starter</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/peeking.html">What to expect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/local.html">Running it locally</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/internals.html">How does it work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/kubernetes.html">Deploying to Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quarkus-mqtt-starter/cloud.html">Moving to the cloud</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">From WiFi to Websocket</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="toolchain.html">Embedded toolchain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="drogue-cloud.html">Drogue Cloud setup</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="firmware.html">Device firmware</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="websocket.html">Websocket Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="db-and-grafana.html">TimescaleDB and Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../timeseries-as-a-service/index.html">Time series data, using managed services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/timescale.html">Timescale</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/knative.html">Knative</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/drogue.html">Drogue Cloud</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/grafana.html">Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/simulating-data.html">Simulating data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../timeseries-as-a-service/summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Drogue IoT Workshops</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../drogue-ajour/dev/index.html">Drogue Ajour</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-ajour/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-cloud/dev/index.html">Drogue Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-cloud/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.9/index.html">0.9</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.8/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../drogue-cloud/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-device/dev/index.html">Drogue Device</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-device/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../drogue-book/index.html">Drogue IoT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../drogue-book/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Drogue IoT Workshops</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../drogue-book/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Drogue IoT Workshops</a></li>
    <li><a href="index.html">From WiFi to Websocket</a></li>
    <li><a href="firmware.html">Device firmware</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/drogue-iot/drogue-workshops/edit/main/modules/wifi-websockets/pages/firmware.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Device firmware</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The next step is to compile and flash the device&#8217;s firmware.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clone_the_git_repository"><a class="anchor" href="#_clone_the_git_repository"></a>Clone the Git repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clone the git repository with the workshops:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">git clone https://github.com/drogue-iot/drogue-workshops</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the next steps, you will need to change into the sub-directory <code>examples/wifi-websockets-workshop</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cd examples/wifi-websockets-workshop</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you don&#8217;t use the iot01a board, you will need to adapt the firmware to match your device and
hardware configuration!
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_update_the_device_configuration"><a class="anchor" href="#_update_the_device_configuration"></a>Update the device configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the device to access your WiFi network and Drogue Cloud, you must add the WiFi and device credentials to the <code>~/.drogue/config.toml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">hostname = "http.sandbox.drogue.cloud" # Replace with your own Drogue Cloud instance if you are not using the sandbox
port = "443"
wifi-ssid = "..."                      # The WiFi network SSID
wifi-password = "..."                  # The WiFi network pre-shared key
http-username = "..."                  # The device username (I.e. `device1@wifi-workshop`)
http-password = "..."                  # The device password (I.e. `mysecretpassword`)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compile_and_flash"><a class="anchor" href="#_compile_and_flash"></a>Compile and flash</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can now compile and flash the firmware. Execute the following command:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You need to have the developer board attached to your computer.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">DEFMT_LOG=info PROBE_RUN_CHIP=STM32L475VG cargo run --release --features b-l475e-iot01a --no-default-features</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You might have an IoT01A board with a different chip, e.g. <code>L4S5VI</code>. Please check your board and use appropriate
value for the <code>PROBE_RUN_CHIP</code> variable , like <code>PROBE_RUN_CHIP=STM32L4S5VI</code>:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">DEFMT_LOG=info PROBE_RUN_CHIP=STM32L4S5VI cargo run --release --features b-l4s5i-iot01a --no-default-features</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_checking_the_result"><a class="anchor" href="#_checking_the_result"></a>Checking the result</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you flashed and started the program, <code>cargo run</code> will keep attached to the application running on the development
board. The output should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">     Running <code>probe-run target/thumbv7em-none-eabihf/release/wifi-websockets-workshop</code>
(HOST) WARN  (BUG) location info is incomplete; it will be omitted from the output
(HOST) INFO  flashing program (164.62 KiB)
(HOST) INFO  success!
────────────────────────────────────────────────────────────────────────────────
 INFO  Starting eS-WiFi adapter!
 INFO  eS-WiFi adapter is ready
 INFO  Started...
 INFO  Joining WiFi network... <i class="conum" data-value="1"></i><b>(1)</b>
 INFO  WiFi network joined
 INFO  Application initialized. Press 'User' button to send data
 INFO  Sending temperature measurement number 0 <i class="conum" data-value="2"></i><b>(2)</b>
 INFO  Connected to 192.168.1.2:8088
 INFO  Response status: Accepted <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Successfully joined the WiFi network</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>At this point the HTTP request is going to be sent</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The Response status indicates if data was sent successfully</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pay attention to the output in the event of an error.</p>
</div>
<div class="paragraph">
<p>The sensor data is automatically sent every 30 seconds. To send a message to Drogue Cloud manually, press the blue button on the board.</p>
</div>
<div class="paragraph">
<p>If the device is sending data successfully, we can confirm that the event is processed by Drogue Cloud by opening the <a href="https://sandbox.drogue.cloud">web console</a>, navigate to the "Spy", and start it, using the Drogue application name you have assigned earlier.</p>
</div>
<div class="paragraph">
<p>On the web console, you should see the event, as received by Drogue Cloud.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/spy-workshop.png" alt="Screenshot of event spy"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you’re experiencing problems, try setting the <code>VID:PID</code> values to that of your probe (you can find that from lsusb once your board is powered).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;ENV&gt; cargo run &lt;ARGS&gt; -- --probe &lt;VID&gt;:&lt;PID&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the B-L4S5I-IOT01A board can have issues with running <code>cargo run</code> multiple times, leading to errors like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Error: An error with the usage of the probe occured

Caused by:
    Operation timed out</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you experience that, the best way to restore the board is to reconnect it and use <code>st-flash</code> utility to write any binary to it, like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">st-flash write ../target/thumbv7em-none-eabihf/release/wifi-websockets-workshop.d 0x8000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>After reconnecting the board again, you should be able to use <code>cargo run</code> again.</p>
</div>
<div class="paragraph">
<p>If your application starts but reports errors like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ERROR Error sending measurement</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can run it by using <code>DEFMT_LOG=trace</code> to get more information about the error.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
